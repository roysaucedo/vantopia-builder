<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vantopia ‚Äî Build Your Van Kit</title>
<style>
  :root{
    --bg:#f7f7f5; --panel:#ffffff; --ink:#1a1a1a; --sub:#6b7280;
    --brand:#1f6f63; --brand-2:#aac7be; --muted:#e9ecef;
    --ok:#156d3f; --err:#a00020; --radius:18px;
    --shadow:0 10px 30px rgba(10,20,10,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    /* background:var(--bg); */
    background:
    var(--bg)
    url("https://static.wixstatic.com/media/11062b_560805ef563246db96e8ecec2d701f6f~mv2.png/v1/fill/w_3019,h_1684,al_c,q_95,enc_avif,quality_auto/11062b_560805ef563246db96e8ecec2d701f6f~mv2.png")
    center / cover no-repeat fixed;
    color:var(--ink);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial
  }
  
  .wrapper{max-width:1500px;margin:20px auto;padding:16px}
  .header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.04em}
  .tagline{color:var(--sub);font-size:.95rem}
  .stepper{display:flex;gap:6px;margin:10px 0 18px;overflow-x:auto;overscroll-behavior-x:contain;-webkit-overflow-scrolling:touch;padding-bottom:6px;scroll-snap-type:x proximity}
  .stepper::-webkit-scrollbar{height:6px}
  .stepper::-webkit-scrollbar-thumb{background:var(--muted);border-radius:999px}
  .step{flex:0 0 auto;min-width:140px;white-space:nowrap;scroll-snap-align:start;position:relative;background:var(--panel);border:1px solid var(--muted);border-radius:12px;padding:8px 10px;text-align:center;font-weight:700;color:var(--sub);cursor:pointer;user-select:none}
  .step:focus{outline:2px solid color-mix(in srgb, var(--brand) 50%, transparent)}
  .step[data-active="true"]{border-color:var(--brand);color:var(--brand);box-shadow:0 0 0 2px color-mix(in srgb, var(--brand) 20%, transparent)}
  .bar{height:6px;background:var(--muted);border-radius:999px;overflow:hidden;margin-top:8px}
  .bar>span{display:block;height:100%;width:0;background:var(--brand);transition:width .35s ease}
  @media (min-width:960px){
    .stepper{display:grid;grid-template-columns:repeat(7,1fr);overflow:visible;padding-bottom:0;scroll-snap-type:none}
    .step{min-width:auto}
  }
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}.summary{position:static}}
  .panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .panel h2{margin:.25rem 0 6px;font-size:1.25rem}
  .panel p.lead{color:var(--sub);margin:0 0 10px}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:8px}
  @media (max-width:720px){.cards{grid-template-columns:1fr}}
  @media (min-width:960px){.cards.van-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .card{border:1px solid var(--muted);border-radius:16px;overflow:hidden;background:#fff;display:flex;flex-direction:column}
  .card .img{aspect-ratio:4/3;background:#f1f5f4}
  .card .img img{width:100%;height:100%;object-fit:cover;display:block}
  .card .body{padding:12px}
  .card h3{margin:.1rem 0 .25rem;font-size:1rem}
  .card .price{color:var(--ink);font-weight:700}
  .card .sub{color:var(--sub);font-size:.9rem}
  .card .select{margin:12px;gap:10px;display:flex;align-items:center;justify-content:space-between}
  .checkwrap{display:flex;align-items:center;gap:10px}
  .checkbox{width:22px;height:22px;border:2px solid var(--brand);border-radius:6px;display:grid;place-items:center;cursor:pointer;background:#fff;flex:0 0 22px}
  .checkbox[data-on="true"]{background:var(--brand)}
  .checkbox svg{width:14px;height:14px;stroke:#fff;stroke-width:3;fill:none;opacity:0;transition:opacity .2s}
  .checkbox[data-on="true"] svg{opacity:1}
  .none-pill{margin-left:auto;font-size:.85rem;color:var(--sub);cursor:pointer;text-decoration:underline}
  .summary{position:sticky;top:12px;height:max-content}
  .summary h3{margin:.25rem 0 .75rem}
  .sum-row{display:flex;justify-content:space-between;gap:10px;margin:6px 0;color:var(--ink)}
  .divider{height:1px;background:var(--muted);margin:10px 0}
  .total{display:flex;justify-content:space-between;font-weight:800;font-size:1.1rem}
  .note{font-size:.9rem;color:var(--sub)}
  button,.btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-ghost{background:#eef3f1;color:var(--brand)}
  .nav{display:flex;justify-content:space-between;margin-top:16px}
  .nav .left{display:flex;gap:10px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.form-grid{grid-template-columns:1fr}}
  label{display:block;font-weight:700;margin-bottom:6px}
  input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--muted);background:#fff;font:inherit}
  textarea{min-height:110px;resize:vertical}
  .alert{background:#fff3f3;border:1px solid #ffd7d7;color:var(--err);padding:12px;border-radius:12px;margin-top:10px}
  .success{background:#ecfdf3;border:1px solid #c1f1d8;color:var(--ok);padding:12px;border-radius:12px;margin-top:10px}
  .small{font-size:.85rem;color:var(--sub)}
  .footer-note{margin-top:8px;color:var(--sub);font-size:.9rem}
</style>
<link rel="icon" href="https://fav.farm/üöö" />
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div>
      <img style="width: 100px;" src="https://static.wixstatic.com/media/2d2f9b_d5e859b8ac9249738ba93bb5a42eb5eb~mv2.png/v1/fill/w_200,h_194,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/vantopia22.png" alt="Van topia Logo">
    </div>
    <div>
      <a class="tagline" href="https://www.vantopiavans.com/">Return to website</a>
    </div>
  </div>

  <div class="header">
    <div>
      <div class="brand">Build Your Van Kit</div>
      <div class="tagline">Choose your layout in 7 easy steps. We'll follow up to confirm and process payment.</div>
    </div>
    <div style="min-width:180px">
      <div class="bar" aria-hidden="true"><span id="progress"></span></div>
    </div>
  </div>

  <div class="stepper" id="stepper" role="tablist" aria-label="Steps">
    <div class="step" data-active="true" tabindex="0">1 ¬∑ Van Model</div>
    <div class="step" tabindex="0">2 ¬∑ Bed Base</div>
    <div class="step" tabindex="0">3 ¬∑ Flooring</div>
    <div class="step" tabindex="0">4 ¬∑ Panels</div>
    <div class="step" tabindex="0">5 ¬∑ Front Module</div>
    <div class="step" tabindex="0">6 ¬∑ Accessories</div>
    <div class="step" tabindex="0">7 ¬∑ Details</div>
  </div>

  <div class="grid">
    <div id="steps"></div>
    <aside class="summary panel" aria-live="polite">
      <h3>Your Build</h3>
      <div id="summaryLines"></div>
      <div class="divider"></div>
      <div class="total"><span>Estimated Total</span><span id="sumTotal">$0</span></div>
      <p class="note">Prices are estimates; tax, shipping & installation are finalized by our team.</p>
    </aside>
  </div>

  <p class="footer-note small">Your selections auto-save in this browser.</p>
  <div id="submitStatus"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  /* ======== 0) CONFIG ======== */
  // Points to your serverless function (Netlify). For Vercel, change to /api/vantopia-submit
  const WEBHOOK_URL = "/.netlify/functions/vantopia-submit";

  const CATALOG = {
    van_model: {
      title: "Step 1 ¬∑ Select Your Van Model",
      type: "single", required: true,
      options: [
        { id:"sprinter_144", name:"Sprinter 144", img:"https://static.wixstatic.com/media/4b7f87_fc0a4a4f1bd341fea91642d7eadf49bd~mv2.png", blurb:"Compact Sprinter" },
        { id:"sprinter_170", name:"Sprinter 170", img:"https://static.wixstatic.com/media/4b7f87_fc0a4a4f1bd341fea91642d7eadf49bd~mv2.png", blurb:"Extended Sprinter" },
        { id:"sprinter_170_ext", name:"Sprinter 170 EXT", img:"https://static.wixstatic.com/media/4b7f87_fc0a4a4f1bd341fea91642d7eadf49bd~mv2.png", blurb:"Extended Sprinter" },
        { id:"transit_long", name:"Transit 148 Long", img:"https://static.wixstatic.com/media/4b7f87_02843e1f162044b7ba6b77141bdd38c3~mv2.png", blurb:"Ford Transit Long" },
        { id:"transit_extended", name:"Transit 148 Extended", img:"https://static.wixstatic.com/media/4b7f87_02843e1f162044b7ba6b77141bdd38c3~mv2.png", blurb:"Ford Transit Extended" },
        { id:"promaster_136", name:"Promaster 136", img:"https://static.wixstatic.com/media/4b7f87_f9b1a52afbc84969bf51ba452073dd60~mv2.png", blurb:"Compact Promaster" },
        { id:"promaster_159", name:"Promaster 159", img:"https://static.wixstatic.com/media/4b7f87_f9b1a52afbc84969bf51ba452073dd60~mv2.png", blurb:"Extended Promaster" },
        { id:"promaster_159_ext", name:"Promaster 159 EXT", img:"https://static.wixstatic.com/media/4b7f87_f9b1a52afbc84969bf51ba452073dd60~mv2.png", blurb:"Extended Promaster" },
      ]
    },
    bed_base: {
      title: "Step 2 ¬∑ Bed Base Kit",
      type: "single", required: true,
      getPricing: function() {
        return {
          raised_bed: {
            base: 3950,
            premiums: {
              sprinter_170: 1000,
              sprinter_170_ext: 1000,
              transit_extended: 1000,
              promaster_159: 1000,
              promaster_159_ext: 1000
            }
          },
          dinette_bed: {
            base: 5950,
            premiums: {
              sprinter_170: 1000,
              sprinter_170_ext: 1000,
              transit_extended: 1000,
              promaster_159: 1000,
              promaster_159_ext: 1000
            }
          }
        };
      },
      options: [
        { id:"raised_bed", name:"Raised Bed Cabinetry Kit", basePrice: 3950, img:"https://static.wixstatic.com/media/2d2f9b_acc60ec5fa354a51960e85c478633297~mv2.png/v1/fill/w_1960,h_1102,al_c,q_95,usm_0.66_1.00_0.01,enc_avif,quality_auto/2d2f9b_acc60ec5fa354a51960e85c478633297~mv2.png", blurb:"Was $5,950 - Now starting at $3,950 | Bedframe, overheads, galley, tray table, closet, accessory cabs, mounting rail, hardware." },
        { id:"dinette_bed", name:"Dinette Bed Cabinetry Kit", basePrice: 5950, img:"https://static.wixstatic.com/media/2d2f9b_c4b2a806730b46c78043e9880ed8206e~mv2.png/v1/fill/w_1960,h_1102,al_c,q_95,usm_0.66_1.00_0.01,enc_avif,quality_auto/2d2f9b_c4b2a806730b46c78043e9880ed8206e~mv2.png", blurb:"Was $7,950 - Now starting at $5,950 | Convertible dinette to bed plus overheads, galley, tray, closet, accessories." },
      ]
    },
    flooring: {
      title: "Step 3 ¬∑ Flooring",
      type: "single-or-none", required: false,
      getPricing: function() {
        return {
          insul_euro: {
            base: 2850,
            premiums: {
              sprinter_170: 800,
              sprinter_170_ext: 800,
              transit_extended: 800,
              promaster_159: 800,
              promaster_159_ext: 800
            }
          }
        };
      },
      options: [
        { id:"insul_euro", name:"Insulated Europly Flooring", basePrice: 2850, img:"https://static.wixstatic.com/media/2d2f9b_f04eec3f9ec541dfae78bd3b1163223d~mv2.jpg/v1/fill/w_1960,h_1102,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/2d2f9b_f04eec3f9ec541dfae78bd3b1163223d~mv2.jpg", blurb:"Interlocking sections, 5\" seam insulation, trims & hardware." }
      ]
    },
    panels: {
      title: "Step 4 ¬∑ Wall & Ceiling Panels",
      type: "single", required: true,
      getPricing: function() {
        return {
          acm: {
            base: 2850,
            premiums: {
              sprinter_170: 400,
              sprinter_170_ext: 400,
              transit_extended: 400,
              promaster_159: 400,
              promaster_159_ext: 400
            }
          },
          melamine: {
            base: 1150,
            premiums: {
              sprinter_170: 225,
              sprinter_170_ext: 225,
              transit_extended: 225,
              promaster_159: 225,
              promaster_159_ext: 225
            }
          }
        };
      },
      options: [
        { id:"acm", name:"ACM Paneling", basePrice: 2850, img:"https://static.wixstatic.com/media/2d2f9b_be361947bb784e69a4cf7d4aff4be9b0~mv2.jpg/v1/fill/w_420,h_262,al_c,lg_1,q_85/2d2f9b_be361947bb784e69a4cf7d4aff4be9b0~mv2.webp", blurb:"Durable aluminum composite." },
        { id:"melamine", name:"Melamine Ply Paneling", basePrice: 1150, img:"https://static.wixstatic.com/media/2d2f9b_b43c8cfa88414aee999dfbf11e7a67d0~mv2.jpg/v1/fill/w_960,h_598,al_c,q_85,usm_0.66_1.00_0.01/2d2f9b_b43c8cfa88414aee999dfbf11e7a67d0~mv2.webp", blurb:"Lightweight & clean." }
      ]
    },
    front_module: {
      title: "Step 5 ¬∑ Front Module",
      type: "single-or-none", required: false,
      options: [
        { id:"pantry_combo", name:"Pantry Combo Module", price: 1950, img:"https://static.wixstatic.com/media/4b7f87_105e956e305a494d80b7cf98a8acb2e3~mv2.png/v1/fill/w_776,h_682,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/Pantry%20Combo%20Module.png", blurb:"Compact pantry storage." },
        { id:"window_combo", name:"Window Combo Module", price: 1950, img:"https://static.wixstatic.com/media/4b7f87_a7d7dd0cbe2e459197949a4c6dc547b6~mv2.png/v1/fill/w_750,h_682,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/Window%20Combo%20Module.png", blurb:"Window + storage." },
        { id:"indoor_bath", name:"Preassembled Indoor Bathroom Module", price: 9950, img:"https://static.wixstatic.com/media/2d2f9b_68be95a8c93c48d596b891bfb018bd74~mv2.jpeg/v1/fill/w_1960,h_1102,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/2d2f9b_68be95a8c93c48d596b891bfb018bd74~mv2.jpeg", blurb:"Self-contained bathroom." }
      ]
    },
    accessories: {
      title: "Step 6 ¬∑ Accessories",
      type: "multi", required: false,
      options: [
        { id:"bike_slider", name:"Bike & Storage Slider", price: 750, img:"https://static.wixstatic.com/media/4b7f87_8426031d57514266881361588f1380b0~mv2.png/v1/fill/w_776,h_682,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/bike%20Module.png", blurb:"Slide-out base for bikes & gear." },
        { id:"dinette_cushions", name:"Dinette Cushions", price: 1750, img:"https://static.wixstatic.com/media/4b7f87_099fe720220e439aa8c67c0108872ce9~mv2.png/v1/fill/w_776,h_682,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/dinette%20cushions.png", blurb:"Upholstered cushions sized to our dinette." },
        { id:"switch_fuse", name:"Prewired Switch & Fuse Panel", price: 450, img:"https://static.wixstatic.com/media/4b7f87_3abc6e9417ea4f9288cc0861ced47e44~mv2.avif/v1/fill/w_750,h_682,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/2d2f9b_5b0fa7cf68564b2591e5edc4348d8b66~mv2.avif", blurb:"Clean power distribution." }
      ]
    }
  };

  /* ======== 1) STATE ======== */
  const STATE_KEY = "vantopia.build.v2";
  let state = {};
  try { state = JSON.parse(localStorage.getItem(STATE_KEY) || "{}"); } catch(_) { state = {}; }
  const money = n => `$${Number(n||0).toLocaleString()}`;

  // Generic function to get dynamic pricing for any product
  function getDynamicPrice(catalogKey, itemId, vanModel) {
    const cfg = CATALOG[catalogKey];
    const item = cfg.options.find(o => o.id === itemId);
    if (!item) return 0;
    
    // If there's no getPricing function, return the static price
    if (!cfg.getPricing) {
      return item.price || 0;
    }
    
    const pricing = cfg.getPricing();
    const itemPricing = pricing[itemId];
    if (!itemPricing) return item.basePrice || item.price || 0;
    
    const premium = itemPricing.premiums[vanModel] || 0;
    return itemPricing.base + premium;
  }

  // Backwards compatibility - keep the old function name
  function getBedPrice(bedId, vanModel) {
    return getDynamicPrice('bed_base', bedId, vanModel);
  }

  /* ======== 2) DOM HOOKS ======== */
  const stepsEl = document.getElementById("steps");
  const progressEl = document.getElementById("progress");
  const stepperEl = document.getElementById("stepper");

  const groupKeys = Object.keys(CATALOG);
  const detailsStepIndex = groupKeys.length;
  let current = Number(state.__step || 0);

  function setStep(i){
    current = Math.max(0, Math.min(i, detailsStepIndex));
    state.__step = current; persist();
    updateUI();
    scrollTo({ top:0, behavior:"smooth" });
  }

  function updateUI(){
    [...stepperEl.children].forEach((el, idx)=>{ el.dataset.active = (idx===current); });
    const pct = (current/(detailsStepIndex))*100;
    progressEl.style.width = pct+"%";

    stepsEl.innerHTML = "";
    if(current < detailsStepIndex){
      const key = groupKeys[current];
      stepsEl.appendChild(renderStep(key, CATALOG[key]));
    }else{
      stepsEl.appendChild(renderDetails());
    }
    renderSummary();
    scrollActiveStepIntoView();
  }

  /* clickable stepper */
  [...stepperEl.children].forEach((el, idx)=>{
    el.addEventListener("click", ()=>setStep(idx));
    el.addEventListener("keypress", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setStep(idx);} });
  });

  /* ======== 3) STEP PANELS ======== */
  function renderStep(key, cfg){
    const panel = div("panel");
    panel.innerHTML = `<h2>${cfg.title}</h2><p class="lead">${leadText(key)}</p>`;
    const wrap = div("cards");
    const selected = state[key] ?? (cfg.type==="multi"? [] : null);

    // For van_model, use 3 columns on desktop
    if(key === "van_model") {
      wrap.classList.add("van-grid");
    }

    cfg.options.forEach(opt=>{
      const card = div("card");
      const img = div("img");
      if(opt.img){ img.appendChild(imgTag(opt.img, opt.name)); }
      card.appendChild(img);

      const body = div("body");
      
      // Calculate dynamic price
      let displayPrice = opt.price || 0;
      let priceLabel = "";
      
      // Check if this category has dynamic pricing
      if(cfg.getPricing) {
        const vanModel = state.van_model;
        if(vanModel) {
          displayPrice = getDynamicPrice(key, opt.id, vanModel);
          const pricing = cfg.getPricing();
          const itemPricing = pricing[opt.id];
          if(itemPricing) {
            const premium = itemPricing.premiums[vanModel] || 0;
            if(premium > 0) {
              priceLabel = ` <span class="small" style="font-weight:400">(+$${premium.toLocaleString()} for your van)</span>`;
            }
          }
        } else {
          displayPrice = opt.basePrice || opt.price || 0;
          priceLabel = ' <span class="small" style="font-weight:400">(select van model first)</span>';
        }
      }
      
      // Build HTML based on whether this is van_model or has pricing
      if(key === "van_model") {
        body.innerHTML = `
          <h3>${opt.name}</h3>
          <div class="sub">${opt.blurb || ""}</div>
        `;
      } else {
        body.innerHTML = `
          <h3>${opt.name}</h3>
          <div class="price">${money(displayPrice)}${priceLabel}</div>
          <div class="sub">${opt.blurb || ""}</div>
        `;
      }
      card.appendChild(body);

      const sel = div("select");
      const check = checkboxEl(isChecked(cfg, selected, opt.id));
      const label = span(opt.name);
      const checkWrap = div("checkwrap"); checkWrap.append(check,label);

      const toggle = ()=>{ toggleSelection(cfg,key,opt.id,check); };
      sel.addEventListener('click', toggle);
      check.addEventListener("click", e=>{ e.stopPropagation(); toggle(); });

      sel.appendChild(checkWrap);
      card.appendChild(sel);
      wrap.appendChild(card);
    });

    if(cfg.type==="single-or-none"){
      const none = document.createElement("button");
      none.type="button";
      none.className="none-pill";
      none.textContent = state[key] ? "Clear selection" : "Skip this step";
      none.onclick = ()=>{ delete state[key]; persist(); updateUI(); };
      panel.appendChild(none);
    }

    panel.appendChild(wrap);
    panel.appendChild(navButtons());
    return panel;
  }

  function renderDetails(){
    const panel = div("panel");
    panel.innerHTML = `
      <h2>Step 7 ¬∑ Your Details</h2>
      <p class="lead">Tell us about your build and how to reach you. We'll confirm availability and finalize payment.</p>
      <div class="form-grid">
        <div><label for="name">Full Name</label><input id="name" placeholder="Jane Doe" value="${state.name||""}"></div>
        <div><label for="email">Email</label><input id="email" type="email" placeholder="you@example.com" value="${state.email||""}"></div>
        <div><label for="phone">Phone</label><input id="phone" placeholder="(###) ###-####" value="${state.phone||""}"></div>
        <div><label for="install">Installation Preference</label><select id="install">${optionList(["Self install","Factory install at Vantopia","Undecided"], state.install)}</select></div>
        <div><label for="timeline">Target Timeline</label><select id="timeline">${optionList(["ASAP","1‚Äì2 months","3‚Äì4 months","Just planning"], state.timeline)}</select></div>
        <div style="grid-column:1/-1"><label for="notes">Notes</label><textarea id="notes" placeholder="Any specific needs, add-ons, or questions?">${state.notes||""}</textarea></div>
      </div>
      <div class="nav">
        <div class="left">
          <button class="btn btn-ghost" type="button" id="backBtn">‚Üê Back</button>
        </div>
        <div>
          <button id="submitBtn" class="btn btn-primary" type="button">Submit Build</button>
        </div>
      </div>
    `;
    queueMicrotask(()=>{
      ["name","email","phone","install","timeline","notes"].forEach(id=>{
        const el = panel.querySelector("#"+id);
        el && el.addEventListener("input", ()=>{ state[id] = el.value; persist(); });
      });
      panel.querySelector("#submitBtn").addEventListener("click", submitOrder);
      panel.querySelector("#backBtn").addEventListener("click", ()=> setStep(detailsStepIndex-1));
    });
    return panel;
  }

  function navButtons(){
    const nav = div("nav");
    const left = div("left");
    const back = button("btn btn-ghost","‚Üê Back", ()=> setStep(current-1));
    if(current>0) left.appendChild(back);
    const next = button("btn btn-primary","Next ‚Üí", ()=> setStep(current+1));
    nav.append(left, next);
    return nav;
  }

  /* ======== 4) SELECTION LOGIC ======== */
  function isChecked(cfg, selected, id){
    if(cfg.type==="multi") return Array.isArray(selected) && selected.includes(id);
    return selected === id;
  }
  function toggleSelection(cfg,key,id){
    if(cfg.type==="multi"){
      const arr = Array.isArray(state[key]) ? state[key] : [];
      const i = arr.indexOf(id);
      if(i>=0){ arr.splice(i,1); } else { arr.push(id); }
      state[key] = arr;
    }else{
      if(state[key] === id){ delete state[key]; } else { state[key] = id; }
    }
    persist(); updateUI();
  }

  /* ======== 5) SUMMARY ======== */
  function renderSummary(){
    const box = document.getElementById("summaryLines");
    box.innerHTML = "";
    let total = 0;

    groupKeys.forEach(k=>{
      const cfg = CATALOG[k];
      const sel = state[k];
      let lines = [];

      if(cfg.type==="multi" && Array.isArray(sel)){
        lines = cfg.options.filter(o=>sel.includes(o.id));
      }else if(sel){
        const one = cfg.options.find(o=>o.id===sel);
        if(one) lines = [one];
      }

      const title = div("small");
      title.textContent = cfg.title.replace(/Step \d+ ¬∑ /,"");
      box.appendChild(title);

      if(!lines.length){
        box.appendChild(row("‚Äî",""));
      }else{
        lines.forEach(o=>{
          let price = o.price || 0;
          
          // Calculate dynamic price if applicable
          if(cfg.getPricing) {
            const vanModel = state.van_model;
            price = vanModel ? getDynamicPrice(k, o.id, vanModel) : (o.basePrice || o.price || 0);
          }
          
          // Only add to total if this isn't van_model (which has no price)
          if(k !== "van_model") {
            total += price;
          }
          
          // Display price only for non-van_model items
          if(k === "van_model") {
            box.appendChild(row(o.name, ""));
          } else {
            box.appendChild(row(o.name, money(price)));
          }
        });
      }
      box.appendChild(div("divider"));
    });

    document.getElementById("sumTotal").textContent = money(total);
  }

  /* ======== 6) SUBMIT via serverless function ======== */
  async function submitOrder(){
    const missing = [];
    groupKeys.forEach(k=>{
      const cfg = CATALOG[k];
      if(cfg.required && cfg.type!=="multi" && !state[k]) missing.push(cfg.title);
    });
    if(!state.name) missing.push("Name");
    if(!state.email) missing.push("Email");

    const status = document.getElementById("submitStatus");
    status.innerHTML = "";

    if(missing.length){
      status.innerHTML = `<div class="alert"><strong>Please complete:</strong> ${missing.join(", ")}</div>`;
      return;
    }

    // Build payload
    const payload = buildPayload();

    const btn = document.getElementById('submitBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Submitting‚Ä¶'; }

    try{
      const res = await fetch(WEBHOOK_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      if(!res.ok){
        console.error('Serverless failed', res.status, text);
        throw new Error('Bad response '+res.status);
      }
      status.innerHTML = `<div class="success"><strong>Thank you!</strong> Your build was submitted. We'll follow up by email shortly.</div>`;
    }catch(err){
      console.error(err);
      status.innerHTML = `<div class="alert">We couldn't reach the server. Please retry in a moment.</div>`;
    }finally{
      if (btn) { btn.disabled = false; btn.textContent = 'Submit Build'; }
    }
  }

  function buildPayload(){
    const selected = {};
    let total = 0;

    groupKeys.forEach(k=>{
      const cfg = CATALOG[k];
      const sel = state[k];
      
      // Skip van_model in selections (it goes in details.van instead)
      if(k === "van_model") return;
      
      if(cfg.type==="multi"){
        const items = (sel||[]).map(id => cfg.options.find(o=>o.id===id)).filter(Boolean);
        selected[k] = items.map(o=>{
          let price = o.price || 0;
          // No dynamic pricing for accessories currently, but keeping structure consistent
          return {id:o.id, name:o.name, price:price};
        });
        total += items.reduce((s,o)=>s+(o.price||0),0);
      }else if(sel){
        const o = cfg.options.find(o=>o.id===sel);
        if(o){ 
          let price = o.price || 0;
          
          // Calculate dynamic price if applicable
          if(cfg.getPricing) {
            const vanModel = state.van_model;
            price = vanModel ? getDynamicPrice(k, o.id, vanModel) : (o.basePrice || o.price || 0);
          }
          
          selected[k] = {id:o.id, name:o.name, price:price}; 
          total += price; 
        }
      }
    });

    // Get van model name for details
    let vanModelName = "";
    if(state.van_model) {
      const vanOpt = CATALOG.van_model.options.find(o => o.id === state.van_model);
      vanModelName = vanOpt ? vanOpt.name : "";
    }

    const details = {
      name: state.name || "",
      email: state.email || "",
      phone: state.phone || "",
      van: vanModelName,
      install: state.install || "",
      timeline: state.timeline || "",
      notes: state.notes || ""
    };

    return {
      meta:{ source:"vantopia_wizard_v2", submittedAt: new Date().toISOString() },
      selections:selected,
      subtotal: total,
      details
    };
  }

  /* ======== 7) HELPERS ======== */
  function leadText(key){
    return ({
      van_model:"Select your van to see accurate pricing.",
      bed_base:"Select your base cabinetry layout. Pricing adjusts based on your van model.",
      flooring:"Choose your insulated floor system (optional if you already have flooring). Pricing adjusts based on your van model.",
      panels:"Pick your wall & ceiling panels. Pricing adjusts based on your van model.",
      front_module:"Add a front module (optional).",
      accessories:"Finish with optional accessories."
    })[key] || "";
  }
  function optionList(arr, cur){
    return ['<option value="" disabled selected hidden>Select...</option>',...arr.map(x=>`<option ${cur===x?'selected':''}>${x}</option>`)].join("");
  }
  function persist(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
  function div(c){ const e=document.createElement("div"); if(c) e.className=c; return e; }
  function span(t){ const e=document.createElement("span"); e.textContent=t; return e; }
  function imgTag(src,alt){ const i=new Image(); i.src=src; i.alt=alt; return i; }
  function button(cls,txt,fn){ const b=document.createElement("button"); b.type="button"; b.className="btn "+cls; b.textContent=txt; b.onclick=fn; return b; }
  function row(l,r){ const e=div("sum-row"); const L=span(l); const R=span(r); e.append(L,R); return e; }

  function checkboxEl(on=false){
    const box = div("checkbox"); box.setAttribute("data-on", on?"true":"false");
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox","0 0 24 24");
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d","M5 13l4 4L19 7");
    path.setAttribute("stroke-linecap","round");
    path.setAttribute("stroke-linejoin","round");
    svg.appendChild(path);
    box.appendChild(svg);
    return box;
  }

  function scrollActiveStepIntoView(){
    const active = stepperEl.children[current];
    if(!active) return;
    active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }

  updateUI();
});
</script>
</body>
</html>